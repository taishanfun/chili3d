本轮方案文档 (最终版 - 2026-01-27)

背景 / Background
- 现象：Vite 5 开发态下加载 chili-wasm.wasm 时报错：
  - expected magic word 00 61 73 6d, found 3c 21 64 6f (HTML 标签起始符 '<!')
  - wasm streaming compile failed: Incorrect response MIME type. Expected application/wasm
- 定位：浏览器请求的 wasm URL 命中 /@fs/F:/... 绝对路径，但 Vite 开发服务器对跨盘符/外部路径触发了 SPA Fallback (返回 index.html)，导致 WASM 实例化失败。
- 变更：用户将 chili3d 代码库复制到了 clientpage 目录下 (g:\工作\项目\DesignCloudPlatform\codeout\clientpage\chili3d)，实现了项目的自包含。

核心目标 / Goal
- 稳定加载 WASM 资源，确保 chili3d-editor 正常初始化。
- 支持本地副本依赖，解除对 F: 盘源码的硬编码依赖。
- 确保 build 和 dev 环境一致性。

最终方案 / Final Solution
- 采用“本地副本 + 站内代理 + 运行时注入”方案：
  1. 依赖重定向：将 clientpage/package.json 中的 file: 依赖指向本地 ./chili3d 副本。
  2. 站内静态化：在 Vite 配置中通过插件将 /chili3d/chili-wasm.wasm 映射到本地副本的 lib 目录。
  3. 运行时注入：在 main.js 中通过 globalThis.__CHILI_WASM_URL__ 动态设置 WASM 路径（支持 BASE_URL）。
  4. 源码适配：chili-wasm/src/wasm.ts 优先读取全局注入的 URL，彻底绕过 Vite 默认的 ?url 逻辑。

实现细节 / Implementation Details
1. package.json:
   - 更新所有 chili-* 路径为 ./chili3d/packages/*
   - 补充 chili-storage 依赖，解决 appBuilder.ts 中的解析报错
2. vite.config.js:
   - 移除 define 中硬编码的 __CHILI_WASM_URL__
   - 优化 serveChiliWasm 插件，使其优先从本地 node_modules 或 ./chili3d 路径解析 WASM
   - 移除 server.fs.allow 对 F: 盘的越权授权
3. clientpage/src/main.js:
   - globalThis.__CHILI_WASM_URL__ = `${import.meta.env.BASE_URL}chili3d/chili-wasm.wasm`;
4. chili-wasm/src/wasm.ts:
   - const overrideUrl = globalThis.__CHILI_WASM_URL__; // 优先使用运行时配置

验证结果 / Verification Results
- Dev Server: http://localhost:2025/ (或 2026) 启动正常。
- WASM 响应：
  - URL: /chili3d/chili-wasm.wasm
  - Status: 200 OK
  - MIME: application/wasm
  - Magic Word: 00-61-73-6D (验证通过)
- Build: npm run build 成功，WASM 自动导出至 dist/chili3d/ 目录。
- Mock Data: beamRebar.vue 和 columnRebar.vue 已成功接入 api.txt 中的模拟数据，不再依赖外部网络请求。

关键结论 / Conclusion
- 通过“本地副本方案”彻底解决了 Vite 跨盘符路径解析的顽疾。
- 运行时注入 URL 比编译时 Define 更具灵活性，能自动适配不同的部署路径 (BASE_URL)。
- 项目现在是一个完全自包含的结构，易于迁移和团队协作。

归档记录 / Archive
- 路径: f:\person\githup\chili3d\history\2026-01-27_session-wasm-vite.txt
- 日期: 2026-01-27

补充问题 / Follow-up
- 现象：浏览器报错 SyntaxError: Unexpected token '<'，堆栈指向 chili-web/src/index.ts init。
- 定位：请求 /iconfont.js 返回 text/html（命中 SPA fallback 的 index.html），导致把 HTML 当 JS 解析。

补充方案（用户选择 A）/ Fix Plan (Chosen A)
- 目标：让 /iconfont.js 在 dev/build 下都返回真实 JS 内容，避免 SPA fallback。
- 实现：
  1. 在 vite.config.js 增加 serveIconfont 插件：
     - dev：拦截任意以 /iconfont.js 结尾的请求，读取本地副本 chili3d/public/iconfont.js 并返回 application/javascript。
     - build：将 iconfont.js 以 asset 形式 emit 到 dist/iconfont.js。
  2. 验证：
     - GET /iconfont.js 返回 Content-Type: application/javascript 且首字符非 '<'。
     - 页面不再出现 Unexpected token '<'，chili-web 初始化继续执行。
